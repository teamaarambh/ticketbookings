<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking Details â€“ Aarambh</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCz5-f1FZMxcfs2yc29hXNLz9636Q2jjKg",
      authDomain: "aarambh-ticket-bookings.firebaseapp.com",
      databaseURL: "https://aarambh-ticket-bookings-default-rtdb.firebaseio.com",
      projectId: "aarambh-ticket-bookings",
      storageBucket: "aarambh-ticket-bookings.firebasestorage.app",
      messagingSenderId: "269445606104",
      appId: "1:269445606104:web:4ee4beecee2d77cd5f45ad"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Save db globally for use in non-module scripts
    window.db = db;
    window.addDoc = addDoc;
    window.collection = collection;
  </script>

  <style>
    /* Popup overlay */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    /* Popup box */
    .popup-box {
      background: #fff;
      padding: 20px 25px;
      border-radius: 10px;
      text-align: center;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* WhatsApp button */
    .whatsapp-btn {
      display: inline-block;
      margin: 12px 0;
      padding: 10px 15px;
      background: #25D366;
      color: white;
      font-weight: bold;
      border-radius: 6px;
      text-decoration: none;
    }

    .whatsapp-btn:hover {
      background: #1ebe5d;
    }

    /* Close button */
    .close-btn {
      background: #ccc;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
    }

    .close-btn:hover {
      background: #bbb;
    }
  </style>
</head>

<body>
  <h2 style="text-align:center;">Enter Your Details</h2>

  <p style="text-align:center;font-weight:bold;">
    Selected Seats: <span id="selectedSeatsSummary"></span><br>
    Total Price: <span id="totalPriceSummary"></span>
  </p>

  <form id="bookingForm" style="max-width:320px;margin:auto;">
    <input type="text" id="userName" placeholder="Your Name" required 
      style="width:100%;margin-bottom:12px;padding:10px;border-radius:8px;border:1px solid #ccc;" />
    <input type="tel" id="userWhatsapp" placeholder="WhatsApp Number" required 
      style="width:100%;margin-bottom:12px;padding:10px;border-radius:8px;border:1px solid #ccc;" />
    <button type="submit" 
      style="width:100%;padding:12px;background:#ff4b2b;color:#fff;font-weight:bold;
      border:none;border-radius:10px;cursor:pointer;">Pay & Confirm Booking</button>
  </form>

  <p id="formStatus" style="text-align:center;color:#c00;font-weight:bold;margin-top:10px;"></p>

  <!-- Booking Success Popup -->
  <div id="bookingSuccessPopup" class="popup-overlay" style="display:none;">
    <div class="popup-box">
      <h3>ðŸŽ‰ Thanks for your booking!</h3>
      <p>Ticket details will be shared on WhatsApp.</p>
      <a href="https://wa.me/917700046566?text=Booking%20done%20on%20portal" 
         target="_blank" class="whatsapp-btn">ðŸ“² Send WhatsApp Message</a>
      <button onclick="closePopup()" class="close-btn">Close</button>
    </div>
  </div>

  <script type="module">
    const selectedSeats = JSON.parse(sessionStorage.getItem("selectedSeats") || "[]");
    const totalPrice = parseInt(sessionStorage.getItem("totalPrice") || "0");

    document.getElementById("selectedSeatsSummary").textContent = selectedSeats.join(", ");
    document.getElementById("totalPriceSummary").textContent = "â‚¹" + totalPrice;

    const form = document.getElementById("bookingForm");
    const statusEl = document.getElementById("formStatus");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("userName").value.trim();
      const whatsapp = document.getElementById("userWhatsapp").value.trim();

      if (!name || !whatsapp || selectedSeats.length === 0) {
        statusEl.textContent = "ðŸš¨ Please fill all details and select seats.";
        return;
      }

      // Razorpay payment options
      const options = {
        key: "rzp_test_IKjpPLMA2flVsR", // Replace with your Razorpay key
        amount: totalPrice * 100,
        currency: "INR",
        name: "Aarambh Theatre",
        description: "Ticket Booking",
        prefill: { name, contact: whatsapp },
        handler: async function (response) {
          try {
            const bookingData = {
              name,
              whatsapp,
              seats: selectedSeats.join(","),
              payment_id: response.razorpay_payment_id,
              timestamp: new Date().toISOString()
            };

            // Save booking to Firebase Firestore
            await window.addDoc(window.collection(window.db, "bookings"), bookingData);
            console.log("Booking saved successfully");

            // Show popup
            document.getElementById("bookingSuccessPopup").style.display = "flex";
            sessionStorage.clear();
          } catch (err) {
            console.error("Save error:", err);
            alert("âŒ Booking save failed: " + err.message);
          }
        },
        modal: {
          ondismiss: () => {
            statusEl.textContent = "Payment cancelled.";
          }
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    });

    window.closePopup = function() {
      document.getElementById("bookingSuccessPopup").style.display = "none";
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
